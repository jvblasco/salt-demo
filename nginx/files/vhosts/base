##################################
# **** DO NOT EDIT THIS FILE ****
# This file is managed by Salt
# Any changes will be overwritten
##################################

{%- if redirect %}

server {
    listen 80;
{%- if site['extra_domains'] %}
    server_name {{ site['main_domain'] }} {{ site['extra_domains'] | join(' ') }};
{%- else %}
    server_name {{ site['main_domain'] }};
{%- endif %}
    return 301 https://$http_host$request_uri;
}
{%- endif %}

server {
{%- if ssl %}
    listen 443 ssl;
    {%- if site['letsencrypt'] %}
    ssl_certificate /etc/letsencrypt/live/{{ site['main_domain'] }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ site['main_domain'] }}/privkey.pem;
    {%- else %}
    ssl_certificate /etc/nginx/certificates/{{ site['main_domain'] }}.pem;
    ssl_certificate_key /etc/nginx/certificates/{{ site['main_domain'] }}.key;
    {%- endif %}
    ssl_protocols TLSv1.2;
    # SSL tunning
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_dhparam /etc/nginx/dhparams.pem;
    ssl_ecdh_curve secp384r1;
{%- else %}
    {%- if localhost %}
    listen 127.0.0.1:10080;
    {%- else %}
    listen 80;
    {%- endif %}
{%- endif %}
{%- if site['extra_domains'] %}
    server_name {{ site['main_domain'] }} {{ site['extra_domains'] | join(' ') }};
{%- else %}
    server_name {{ site['main_domain'] }};
{%- endif %}
{%- if auth %}
    auth_basic "Sebafactory Restricted";
    auth_basic_user_file htpasswd;
    allow 127.0.0.1;
    deny all;
    satisfy any;
{%- endif %}
    set $APP_ROOT /srv/www/{{ app['base_domain'] }}/current;
{%- if app['type'] != 'magento2' %}
    root /srv/www/{{ app['base_domain'] }}/current;
{%- endif %}
{%- if app['balancer'] %}
    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;
{%- endif %}
    access_log /var/log/nginx/{{ site['main_domain'] }}-access.log;
    error_log /var/log/nginx/{{ site['main_domain'] }}-error.log;
{%- if protections %}
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy 'origin';
{%- endif %}
    client_max_body_size 128M;
    autoindex off;
    if ($http_user_agent ~ (woobot|httrack|htmlparser|libwww|JikeSpider|proximic|Sosospider|Baiduspider|msnbot|BBBike|WWWOFFLE|Widow|SuperHTTP|BlackWidow|HTTrack|Pixray|CPython|Spinn3r|Abonti|MSIECrawler|Baiduspider|Siteimprove|Aboundex|80legs|360Spider|Cogentbot|^Alexibot|^asterias|^attach|^BackDoorBot|^BackWeb|Bandit|^BatchFTP|^Bigfoot|^Black.Hole|^BlackWidow|^BlowFish|^BotALot|Buddy|^BuiltBotTough|^Bullseye|^BunnySlippers|^Cegbfeieh|^CheeseBot|^CherryPicker|^ChinaClaw|Collector|Copier|^CopyRightCheck|^cosmos|^Crescent|^Custo|^AIBOT|ZmEu|MJ12bot|MegaIndex|OpenLinkProfiler|spbot|Screaming\ Frog\ SEO\ Spider|Yandex|SiteSucker|AhrefsBot|BLEXBot|HaosouSpider|FAST-WebCrawler|Charlotte|CCBot|Scrapy|DotBot|SemRush|Slurp|OnCrawl|ZoomBot|SeznamBot|linkdexbot|iisbot|linkfluence|SemrushBot|JuziBrowser|\.NET4\.0C|QQDownload|BIDUBrowser|QQBrowser|\.NET\ CLR\ 3\.5|AspiegelBot)) {
        return 403;
    }
    location /.well-known {
	allow all;
        satisfy any;
	root /srv/www/{{ app['base_domain'] }}/current;
        try_files $uri 404;
    }
    include drop.conf;
{%- if extra_frontend_config_base is defined %}
    # START extra frontend base configuration from pillar
    {{ extra_frontend_config_base | indent(4) }}
    # END extra frontend base configuration from pillar
{%- endif %}
{%- if extra_balancer_config is defined %}
    # START extra balancer configuration from pillar
    {{ extra_balancer_config | indent(4) }}
    # END extra balancer configuration from pillar
{%- endif %}
{%- if rewrites %}
{%- for rewrite in rewrites %}
    location ~ {{ rewrite['src'] }} {
        return {{ rewrite.get('code', 301) }} {{ rewrite['dst'] }};
    }
{%- endfor %}
{%- endif %}
    {% block vhost %}{% endblock %}
}
